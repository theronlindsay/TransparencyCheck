FROM docker.io/library/node:22 AS build

WORKDIR /app

# Tools for native deps (sqlite3)
RUN apt-get update \
	&& apt-get install -y python3 make g++ \
	&& rm -rf /var/lib/apt/lists/*

# Copy root and app package files
COPY package*.json ./
COPY apps/server/package.json ./apps/server/
COPY apps/client/package.json ./apps/client/

# Copy lock files if they exist (for deterministic builds)
COPY package-lock.json* ./
RUN mkdir -p ./apps/server ./apps/client
RUN if [ -f /app/package-lock.json ]; then \
      cp /app/package-lock.json ./apps/server/ 2>/dev/null || true; \
      cp /app/package-lock.json ./apps/client/ 2>/dev/null || true; \
    fi

# Install all dependencies (workspace aware)
RUN npm install

COPY . .

# Build server only
RUN npm run build:server

# Prune dev dependencies from workspaces
RUN npm prune --omit=dev --workspaces

FROM docker.io/library/node:22 AS runtime

WORKDIR /app
ENV NODE_ENV=production

# Copy only server files needed at runtime
COPY --from=build /app/package*.json ./
COPY --from=build /app/apps/server/package*.json ./apps/server/
COPY --from=build /app/node_modules ./node_modules
COPY --from=build /app/apps/server/node_modules ./apps/server/node_modules
COPY --from=build /app/apps/server/build ./apps/server/build

RUN mkdir -p /app/db /app/.cache

EXPOSE 3000

CMD ["node", "-r", "dotenv/config", "apps/server/build"]
