{"version":3,"file":"_server-BJwKgBNs.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/openAI/_server.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { OpenAI } from \"openai\";\nimport { b as private_env } from \"../../../../chunks/shared-server.js\";\nconst OPENAI_API_KEY = private_env.OPENAI_API_KEY;\nconst corsHeaders = {\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\n  \"Access-Control-Allow-Headers\": \"Content-Type\"\n};\nasync function OPTIONS() {\n  return new Response(null, { headers: corsHeaders });\n}\nfunction validateRequest(prompt, requestData) {\n  const errors = [];\n  const readingLevelMatch = prompt.match(/Reading Level: (.+)/);\n  if (readingLevelMatch) {\n    const allowedLevels = [\n      \"elementary school reading level\",\n      \"middle school reading level\",\n      \"high school reading level\",\n      \"general adult audience\",\n      \"expertise in policy\"\n    ];\n    const hasValidLevel = allowedLevels.some(\n      (level) => readingLevelMatch[1].toLowerCase().includes(level)\n    );\n    if (!hasValidLevel) {\n      errors.push(\"Invalid reading level specified\");\n    }\n  }\n  const suspiciousPatterns = [\n    /<script/i,\n    /javascript:/i,\n    /onerror=/i,\n    /onclick=/i,\n    /eval\\(/i,\n    /__proto__/i,\n    /constructor\\[/i\n  ];\n  for (const pattern of suspiciousPatterns) {\n    if (pattern.test(prompt)) {\n      errors.push(\"Prompt contains potentially malicious content\");\n      break;\n    }\n  }\n  if (requestData.tools) {\n    if (!Array.isArray(requestData.tools)) {\n      errors.push(\"Tools must be an array\");\n    } else {\n      for (const tool of requestData.tools) {\n        if (!tool.type || typeof tool.type !== \"string\") {\n          errors.push(\"Each tool must have a valid type\");\n          break;\n        }\n        const allowedToolTypes = [\"web_search_preview\", \"function\"];\n        if (!allowedToolTypes.includes(tool.type)) {\n          errors.push(`Invalid tool type: ${tool.type}`);\n          break;\n        }\n      }\n    }\n  }\n  const billTextMatch = prompt.match(/Bill Text:\\n(.+)/s);\n  if (billTextMatch && billTextMatch[1].length > 2e5) {\n    errors.push(\"Bill text exceeds maximum length of 200,000 characters\");\n  }\n  const summaryLengthMatch = prompt.match(/Summary Length: (\\d+)-(\\d+)/);\n  if (summaryLengthMatch) {\n    const minLength = parseInt(summaryLengthMatch[1], 10);\n    const maxLength = parseInt(summaryLengthMatch[2], 10);\n    if (isNaN(minLength) || isNaN(maxLength) || minLength < 50 || maxLength > 500 || minLength >= maxLength) {\n      errors.push(\"Invalid summary length range. Must be between 50-500 characters, with min < max.\");\n    }\n  }\n  return {\n    isValid: errors.length === 0,\n    errors\n  };\n}\nasync function POST({ request }) {\n  try {\n    const { prompt, tools, conversationId } = await request.json();\n    const validation = validateRequest(prompt, { tools });\n    if (!validation.isValid) {\n      console.error(\"Validation failed:\", validation.errors);\n      return json({\n        error: validation.errors.join(\"; \"),\n        validationErrors: validation.errors,\n        success: false\n      }, { status: 400 });\n    }\n    const result = await requestAI(prompt, tools, conversationId);\n    return json({\n      success: true,\n      response: result.text,\n      conversationId: result.conversationId,\n      prompt\n    }, { headers: corsHeaders });\n  } catch (error) {\n    console.error(\"Error in openAI endpoint:\", error);\n    return json({ error: error.message, success: false }, { status: 500, headers: corsHeaders });\n  }\n}\nasync function requestAI(prompt, tools, conversationId = null) {\n  const client = new OpenAI({\n    apiKey: OPENAI_API_KEY\n  });\n  console.log(\"Prompt:\", prompt);\n  if (tools) {\n    console.log(\"Tools enabled:\", tools);\n  }\n  if (conversationId) {\n    console.log(\"Continuing conversation:\", conversationId);\n  }\n  const requestOptions = {\n    model: \"gpt-4o-mini\",\n    input: prompt\n  };\n  if (tools && Array.isArray(tools) && tools.length > 0) {\n    requestOptions.tools = tools;\n  }\n  if (conversationId) {\n    requestOptions.previous_response_id = conversationId;\n  }\n  const response = await client.responses.create(requestOptions);\n  console.log(\"OpenAI Response:\", response);\n  const outputText = response.output_text || \"\";\n  return {\n    text: outputText,\n    conversationId: response.id\n  };\n}\nexport {\n  OPTIONS,\n  POST\n};\n"],"names":[],"mappings":";;;;AAGA,MAAM,cAAc,GAAG,WAAW,CAAC,cAAc;AACjD,MAAM,WAAW,GAAG;AACpB,EAAE,6BAA6B,EAAE,GAAG;AACpC,EAAE,8BAA8B,EAAE,eAAe;AACjD,EAAE,8BAA8B,EAAE;AAClC,CAAC;AACD,eAAe,OAAO,GAAG;AACzB,EAAE,OAAO,IAAI,QAAQ,CAAC,IAAI,EAAE,EAAE,OAAO,EAAE,WAAW,EAAE,CAAC;AACrD;AACA,SAAS,eAAe,CAAC,MAAM,EAAE,WAAW,EAAE;AAC9C,EAAE,MAAM,MAAM,GAAG,EAAE;AACnB,EAAE,MAAM,iBAAiB,GAAG,MAAM,CAAC,KAAK,CAAC,qBAAqB,CAAC;AAC/D,EAAE,IAAI,iBAAiB,EAAE;AACzB,IAAI,MAAM,aAAa,GAAG;AAC1B,MAAM,iCAAiC;AACvC,MAAM,6BAA6B;AACnC,MAAM,2BAA2B;AACjC,MAAM,wBAAwB;AAC9B,MAAM;AACN,KAAK;AACL,IAAI,MAAM,aAAa,GAAG,aAAa,CAAC,IAAI;AAC5C,MAAM,CAAC,KAAK,KAAK,iBAAiB,CAAC,CAAC,CAAC,CAAC,WAAW,EAAE,CAAC,QAAQ,CAAC,KAAK;AAClE,KAAK;AACL,IAAI,IAAI,CAAC,aAAa,EAAE;AACxB,MAAM,MAAM,CAAC,IAAI,CAAC,iCAAiC,CAAC;AACpD,IAAI;AACJ,EAAE;AACF,EAAE,MAAM,kBAAkB,GAAG;AAC7B,IAAI,UAAU;AACd,IAAI,cAAc;AAClB,IAAI,WAAW;AACf,IAAI,WAAW;AACf,IAAI,SAAS;AACb,IAAI,YAAY;AAChB,IAAI;AACJ,GAAG;AACH,EAAE,KAAK,MAAM,OAAO,IAAI,kBAAkB,EAAE;AAC5C,IAAI,IAAI,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE;AAC9B,MAAM,MAAM,CAAC,IAAI,CAAC,+CAA+C,CAAC;AAClE,MAAM;AACN,IAAI;AACJ,EAAE;AACF,EAAE,IAAI,WAAW,CAAC,KAAK,EAAE;AACzB,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,WAAW,CAAC,KAAK,CAAC,EAAE;AAC3C,MAAM,MAAM,CAAC,IAAI,CAAC,wBAAwB,CAAC;AAC3C,IAAI,CAAC,MAAM;AACX,MAAM,KAAK,MAAM,IAAI,IAAI,WAAW,CAAC,KAAK,EAAE;AAC5C,QAAQ,IAAI,CAAC,IAAI,CAAC,IAAI,IAAI,OAAO,IAAI,CAAC,IAAI,KAAK,QAAQ,EAAE;AACzD,UAAU,MAAM,CAAC,IAAI,CAAC,kCAAkC,CAAC;AACzD,UAAU;AACV,QAAQ;AACR,QAAQ,MAAM,gBAAgB,GAAG,CAAC,oBAAoB,EAAE,UAAU,CAAC;AACnE,QAAQ,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE;AACnD,UAAU,MAAM,CAAC,IAAI,CAAC,CAAC,mBAAmB,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;AACxD,UAAU;AACV,QAAQ;AACR,MAAM;AACN,IAAI;AACJ,EAAE;AACF,EAAE,MAAM,aAAa,GAAG,MAAM,CAAC,KAAK,CAAC,mBAAmB,CAAC;AACzD,EAAE,IAAI,aAAa,IAAI,aAAa,CAAC,CAAC,CAAC,CAAC,MAAM,GAAG,GAAG,EAAE;AACtD,IAAI,MAAM,CAAC,IAAI,CAAC,wDAAwD,CAAC;AACzE,EAAE;AACF,EAAE,MAAM,kBAAkB,GAAG,MAAM,CAAC,KAAK,CAAC,6BAA6B,CAAC;AACxE,EAAE,IAAI,kBAAkB,EAAE;AAC1B,IAAI,MAAM,SAAS,GAAG,QAAQ,CAAC,kBAAkB,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC;AACzD,IAAI,MAAM,SAAS,GAAG,QAAQ,CAAC,kBAAkB,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC;AACzD,IAAI,IAAI,KAAK,CAAC,SAAS,CAAC,IAAI,KAAK,CAAC,SAAS,CAAC,IAAI,SAAS,GAAG,EAAE,IAAI,SAAS,GAAG,GAAG,IAAI,SAAS,IAAI,SAAS,EAAE;AAC7G,MAAM,MAAM,CAAC,IAAI,CAAC,kFAAkF,CAAC;AACrG,IAAI;AACJ,EAAE;AACF,EAAE,OAAO;AACT,IAAI,OAAO,EAAE,MAAM,CAAC,MAAM,KAAK,CAAC;AAChC,IAAI;AACJ,GAAG;AACH;AACA,eAAe,IAAI,CAAC,EAAE,OAAO,EAAE,EAAE;AACjC,EAAE,IAAI;AACN,IAAI,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,cAAc,EAAE,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE;AAClE,IAAI,MAAM,UAAU,GAAG,eAAe,CAAC,MAAM,EAAE,EAAE,KAAK,EAAE,CAAC;AACzD,IAAI,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE;AAC7B,MAAM,OAAO,CAAC,KAAK,CAAC,oBAAoB,EAAE,UAAU,CAAC,MAAM,CAAC;AAC5D,MAAM,OAAO,IAAI,CAAC;AAClB,QAAQ,KAAK,EAAE,UAAU,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC;AAC3C,QAAQ,gBAAgB,EAAE,UAAU,CAAC,MAAM;AAC3C,QAAQ,OAAO,EAAE;AACjB,OAAO,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AACzB,IAAI;AACJ,IAAI,MAAM,MAAM,GAAG,MAAM,SAAS,CAAC,MAAM,EAAE,KAAK,EAAE,cAAc,CAAC;AACjE,IAAI,OAAO,IAAI,CAAC;AAChB,MAAM,OAAO,EAAE,IAAI;AACnB,MAAM,QAAQ,EAAE,MAAM,CAAC,IAAI;AAC3B,MAAM,cAAc,EAAE,MAAM,CAAC,cAAc;AAC3C,MAAM;AACN,KAAK,EAAE,EAAE,OAAO,EAAE,WAAW,EAAE,CAAC;AAChC,EAAE,CAAC,CAAC,OAAO,KAAK,EAAE;AAClB,IAAI,OAAO,CAAC,KAAK,CAAC,2BAA2B,EAAE,KAAK,CAAC;AACrD,IAAI,OAAO,IAAI,CAAC,EAAE,KAAK,EAAE,KAAK,CAAC,OAAO,EAAE,OAAO,EAAE,KAAK,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,OAAO,EAAE,WAAW,EAAE,CAAC;AAChG,EAAE;AACF;AACA,eAAe,SAAS,CAAC,MAAM,EAAE,KAAK,EAAE,cAAc,GAAG,IAAI,EAAE;AAC/D,EAAE,MAAM,MAAM,GAAG,IAAI,MAAM,CAAC;AAC5B,IAAI,MAAM,EAAE;AACZ,GAAG,CAAC;AACJ,EAAE,OAAO,CAAC,GAAG,CAAC,SAAS,EAAE,MAAM,CAAC;AAChC,EAAE,IAAI,KAAK,EAAE;AACb,IAAI,OAAO,CAAC,GAAG,CAAC,gBAAgB,EAAE,KAAK,CAAC;AACxC,EAAE;AACF,EAAE,IAAI,cAAc,EAAE;AACtB,IAAI,OAAO,CAAC,GAAG,CAAC,0BAA0B,EAAE,cAAc,CAAC;AAC3D,EAAE;AACF,EAAE,MAAM,cAAc,GAAG;AACzB,IAAI,KAAK,EAAE,aAAa;AACxB,IAAI,KAAK,EAAE;AACX,GAAG;AACH,EAAE,IAAI,KAAK,IAAI,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE;AACzD,IAAI,cAAc,CAAC,KAAK,GAAG,KAAK;AAChC,EAAE;AACF,EAAE,IAAI,cAAc,EAAE;AACtB,IAAI,cAAc,CAAC,oBAAoB,GAAG,cAAc;AACxD,EAAE;AACF,EAAE,MAAM,QAAQ,GAAG,MAAM,MAAM,CAAC,SAAS,CAAC,MAAM,CAAC,cAAc,CAAC;AAChE,EAAE,OAAO,CAAC,GAAG,CAAC,kBAAkB,EAAE,QAAQ,CAAC;AAC3C,EAAE,MAAM,UAAU,GAAG,QAAQ,CAAC,WAAW,IAAI,EAAE;AAC/C,EAAE,OAAO;AACT,IAAI,IAAI,EAAE,UAAU;AACpB,IAAI,cAAc,EAAE,QAAQ,CAAC;AAC7B,GAAG;AACH;;;;"}