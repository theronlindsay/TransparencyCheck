{"version":3,"file":"_server-B8yXEAbK.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/pdf/_server.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport fs from \"fs/promises\";\nimport path from \"path\";\nimport crypto from \"crypto\";\nconst corsHeaders = {\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Methods\": \"GET, OPTIONS\",\n  \"Access-Control-Allow-Headers\": \"Content-Type\"\n};\nasync function OPTIONS() {\n  return new Response(null, { headers: corsHeaders });\n}\nconst PDF_CACHE_DIR = path.join(process.cwd(), \".cache\", \"pdfs\");\nasync function ensureCacheDir() {\n  try {\n    await fs.mkdir(PDF_CACHE_DIR, { recursive: true });\n  } catch (err) {\n    console.error(\"Error creating cache directory:\", err);\n  }\n}\nfunction generateFileName(url) {\n  const hash = crypto.createHash(\"sha256\").update(url).digest(\"hex\");\n  const billMatch = url.match(/\\/bills\\/(\\w+)\\/BILLS-/);\n  const billId = billMatch ? billMatch[1] : \"unknown\";\n  return `${billId}_${hash.substring(0, 16)}.pdf`;\n}\nasync function GET({ url }) {\n  const pdfUrl = url.searchParams.get(\"url\");\n  if (!pdfUrl) {\n    return json({ error: \"URL parameter is required\" }, { status: 400, headers: corsHeaders });\n  }\n  console.log(\"\\n========================================\");\n  console.log(\"PDF PROXY REQUEST\");\n  console.log(\"========================================\");\n  console.log(\"Requested PDF URL:\", pdfUrl);\n  console.log(\"Full request URL:\", url.href);\n  try {\n    await ensureCacheDir();\n    const fileName = generateFileName(pdfUrl);\n    const filePath = path.join(PDF_CACHE_DIR, fileName);\n    console.log(\"Cache filename (hash):\", fileName);\n    console.log(\"Cache file path:\", filePath);\n    let pdfBuffer;\n    try {\n      pdfBuffer = await fs.readFile(filePath);\n      console.log(\"✅ Serving cached PDF from disk\");\n      console.log(\"   File size:\", pdfBuffer.length, \"bytes\");\n      console.log(\"========================================\\n\");\n    } catch (err) {\n      console.log(\"⬇️  PDF not cached, downloading from Congress.gov...\");\n      const response = await fetch(pdfUrl);\n      if (!response.ok) {\n        console.log(\"❌ Failed to fetch PDF:\", response.status);\n        console.log(\"========================================\\n\");\n        throw new Error(`Failed to fetch PDF: ${response.status}`);\n      }\n      pdfBuffer = await response.arrayBuffer();\n      await fs.writeFile(filePath, Buffer.from(pdfBuffer));\n      console.log(\"✅ Downloaded and cached PDF\");\n      console.log(\"   File size:\", pdfBuffer.byteLength, \"bytes\");\n      console.log(\"========================================\\n\");\n    }\n    return new Response(pdfBuffer, {\n      headers: {\n        ...corsHeaders,\n        \"Content-Type\": \"application/pdf\",\n        \"Content-Disposition\": 'inline; filename=\"bill.pdf\"',\n        \"Cache-Control\": \"public, max-age=86400\"\n        // Cache for 24 hours\n      }\n    });\n  } catch (error) {\n    console.error(\"Error handling PDF:\", error);\n    return json({ error: error.message }, { status: 500, headers: corsHeaders });\n  }\n}\nexport {\n  GET,\n  OPTIONS\n};\n"],"names":[],"mappings":"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"}